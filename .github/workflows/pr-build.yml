name: pr-build

on:
  push:
    branches:
      - "*"
      - "!master"

env:
  IMAGE: cronjob-cleaner
  K8S_NAMESPACE: monitoring

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - uses: engineerd/setup-kind@v0.5.0

      - uses: actions/setup-go@v2
        with:
          go-version: "^1.15.6"

      - run: go test -v ./... -coverprofile="coverage.txt" -covermode=atomic

      - run: go get

      - run: go install

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: kevinshelaga
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build
        run: |-
          docker build . \
            --tag "kevinshelaga/$IMAGE:${{ github.run_number }}" \
            --tag "kevinshelaga/$IMAGE:latest"

      - name: Set up Kustomize
        run: |-
          curl -sfLo kustomize https://github.com/kubernetes-sigs/kustomize/releases/download/v3.1.0/kustomize_3.1.0_linux_amd64
          chmod u+x ./kustomize

      - name: Copy Manifests
        run: cp -a ./manifests/. .

      - name: Deploy
        run: |-
          ./kustomize edit set image kevinshelaga/$IMAGE:tag=kevinshelaga/$IMAGE:${{ github.run_number }}
          ./kustomize build . | kubectl -n $K8S_NAMESPACE apply -f -
